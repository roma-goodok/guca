<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Graph Unfolding Cellular Automata ‚Äî Demo</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png" />
  <style>
    :root{
      --panel-w: 420px;
      --bg-dark:#101113;
      --bg-panel:#f6f7f9;
      --border:#d8dbe2;
      --accent:#0ea5e9;
      --ok:#16a34a;
      --muted:#6b7280;
      --tile-shadow: 0 0 0 1px rgba(0,0,0,.15) inset;
    }
    *{box-sizing:border-box}
    body{
      margin:0; height:100vh; display:flex; flex-direction:column;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color:#0b0c0e; background:#fff;
    }

    /* Always respect the hidden attribute (prevents accidental overrides) */
    [hidden] { display: none !important; }

    /* Header (collapsible About) */
    header{border-bottom:1px solid var(--border); background:#fff}
    header .wrap{max-width:1400px; margin:0 auto; padding:8px 12px}
    details.about{margin:0 auto; max-width:1400px; padding:6px 12px}
    details.about summary{
      list-style:none; cursor:pointer; user-select:none; outline:none;
      font-weight:600; display:flex; gap:10px; align-items:center;
    }
    details.about summary::-webkit-details-marker{display:none}
    .about-body{color:#222; margin-top:6px; line-height:1.45}
    .about-body p{margin:.4rem 0}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:.85rem; background:#fff}
    .about-row{display:flex; align-items:center; gap:8px; max-width:1400px; margin:0 auto; padding:0 12px;}


    /* Main split layout */
    #main{flex:1; min-height:0; display:flex;}
    #canvas-container{
      flex:1; min-width:0; display:flex; align-items:center; justify-content:center;
      background:#000; border-right:1px solid var(--border); position:relative;
    }
    
    #three-container {
      position:absolute;
      inset:0;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
      z-index:0;           /* canvas under overlays */
    }

    /* hidden is already globally styled; keep consistent behavior */
    #three-container[hidden] {
      display:none !important;
    }

    svg{width:100%; height:100%; background:#000;}

    #ui-panel{
      width:var(--panel-w); min-width:280px; max-width:50vw;
      background:var(--bg-panel); padding:10px; display:flex; flex-direction:column; gap:10px;
      overflow:auto;
    }
    h4{margin:8px 0 6px 0}

    .control-group{background:#fff; border:1px solid var(--border); border-radius:8px; padding:10px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .toggle-group{display:flex; gap:6px}
    .toggle-btn{
      border:1px solid #cfd5dd; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer;
    }
    .toggle-btn.active{background:#111827; color:#fff; border-color:#111827}

    /* Rules ‚Üí gene tiles */
    #rules-section .board{
      display:flex; flex-wrap:wrap; gap:6px; max-height:180px; overflow:auto;
      background:#fff; border:1px solid var(--border); padding:8px; border-radius:8px;
    }
    .gene-tile{
      width:44px; height:28px;
      display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr;
      border-radius:6px; box-shadow:var(--tile-shadow); position:relative;
      border:2px solid transparent;
      cursor:pointer;
    }
    /* .gene-tile span{
      display:block; width:100%; height:100%;
      pointer-events: none;
    } */
    .gene-tile.active{
      /* existing glow kept */
      box-shadow:0 0 10px rgba(34,197,94,.75), var(--tile-shadow);
      border-color:#22c55e;
      border-width:3px;
    }
    .gene-tile.disabled{
      filter:grayscale(100%) brightness(.85);
      opacity:.8;
      border-color:#9ca3af;
      border-style:dashed;
    }
    .gene-tile.disabled span{
      filter:grayscale(100%) brightness(.85);
    }
    .gene-tile:hover{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }
    /* Palette grid (debug) */
    .palette-grid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:8px;
    }
    .palette-chip{
      height:32px;
      border:1px solid var(--border);
      border-radius:8px;
      box-shadow:var(--tile-shadow);
    }


    .legend{font-size:.85rem; color:#374151; display:flex; gap:8px; flex-wrap:wrap}

    /* Footer status bar */
    footer{
      height:34px; background:var(--bg-dark); color:#e5e7eb;
      display:flex; align-items:center; justify-content:space-between; padding:0 12px;
      border-top:1px solid #0b0c0f; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    footer .left, footer .right{display:flex; align-items:center; gap:10px}

    /* Links & edges */
    .link{vector-effect: non-scaling-stroke; stroke-width:2; stroke-linecap:round}

    /* Advanced collapsers */
    details.block summary{
      cursor:pointer; user-select:none; font-weight:600; color:#111827; list-style:none; outline:none;
    }
    details.block summary::-webkit-details-marker{display:none}
    details.block{border:1px solid var(--border); background:#fff; border-radius:8px; padding:8px 10px}

    /* Form bits */
    select, input[type="number"]{padding:6px 8px; border:1px solid #cfd5dd; border-radius:6px; background:#fff}
    label{color:#111827}

    /* --- Responsive toggles -------------------------------------------------- */
    body.mobile-basic header,
    body.mobile-basic #ui-panel,
    body.mobile-basic #advanced-block,
    body.mobile-basic #palette-block,
    body.mobile-basic #gene-inspector,
    body.mobile-basic #rules-section .board + div,  /* hide "Show more" button row */
    body.mobile-basic #download-yaml-button,
    body.mobile-basic #gene-upload {
      display: none !important;
    }

    body.mobile-basic footer {
      /* Keep status bar or hide if you prefer: */
      display:none;
    }

    /* Mobile overlay toolbar (default: hidden) */
    #mobile-toolbar {
      position: absolute;
      top: env(safe-area-inset-top, 8px);
      left: env(safe-area-inset-left, 8px);
      right: env(safe-area-inset-right, 8px);
      bottom: auto;
      display: none;
      gap: 8px;
      align-items: center;  
      justify-content: flex-start;
      padding: 8px;
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(6px);
      border-radius: 12px;
      z-index: 10;
    }

    /* Rules strip on the black canvas (default: hidden) */
    #rules-overlay {
      position: absolute;
      left: env(safe-area-inset-left, 8px);
      right: env(safe-area-inset-right, 8px);
      top: calc(env(safe-area-inset-top, 8px) + 56px);
      bottom: auto;
      display: none;
      gap: 6px;
      align-items: center;
      padding: 8px;
      background: rgba(0,0,0,0.42);
      border-radius: 10px;
      overflow-x: auto;
      overflow-y: hidden;
      flex-wrap: wrap;              /* allow 2+ rows of tiles */
      justify-content: flex-start;
      max-width: 540px;             /* ~10 tiles per row at 48px + gaps */
      max-height: 96px;             /* roughly 2 rows of tiles */
      z-index: 9;
    }


    /* Only show overlays when body has the mobile flag */
    body.mobile-basic #mobile-toolbar,
    body.mobile-basic #rules-overlay {
      display: flex;                /* was block; keep flex layout */
    }
    
    #mobile-toolbar button,
    #mobile-toolbar select {
      font-size: 16px;
      padding: 6px 10px;
      border: 1px solid #cfd5dd;
      border-radius: 8px;
      background: #fff;
    }
    
    #mobile-toolbar button.toggle-active {
      background: #111827;
      color: #fff;
      border-color: #111827;
    }


    /* Shrink tiles slightly in overlay, keep look&feel */
    /* #rules-overlay .gene-tile {
      transform: scale(0.95);
      transform-origin: center;
      border-width: 2px;
      cursor: pointer;
    } */

    #rules-overlay .gene-tile { width: 48px; height: 30px; border-radius: 6px; }
    #rules-overlay::-webkit-scrollbar { height: 6px; }
    #rules-overlay::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.35); border-radius: 4px; }
    
  </style>
</head>
<body class="mobile-basic">
  <header>
    <div class="about-row">
      <details class="about">
        <summary>‚ÑπÔ∏è About this demo</summary>
        <div class="about-body">
          <p>‚ÄúGenes‚Äù are change-tables for a Graph Unfolding Machine (GUM). Each step snapshots node states and applies the first matching rule. The demo lets you load YAML genomes, watch growth, and use a ‚úÇÔ∏è <b>Scissors</b> tool to cut edges.</p>
          <p>Tip: wheel zoom works in both tools; drag nodes when the üñêÔ∏è <b>Move</b> tool is active.</p>
        </div>
      </details>
      <a class="pill" href="https://github.com/roma-goodok/guca" target="_blank" rel="noopener">
        GitHub: roma-goodok/guca
      </a>
    </div>

  </header>

  <div id="main">
    <div id="canvas-container">
      <div id="three-container" hidden></div>
      <svg></svg>
        <div id="mobile-toolbar" aria-label="Mobile controls" hidden>
        <button id="mobile-play">‚ñ∂Ô∏é</button>
        <button id="mobile-reset">‚ü≤</button>
        <button id="mobile-slow">üê¢</button>
        <button id="mobile-sound" title="Toggle mechanical ticking sound">üîà</button>
        <button id="mobile-view-2d" class="toggle-active" title="2D view">2D</button>
        <button id="mobile-view-3d" title="3D view (beta)">3D</button>
        <select id="gene-select-mobile" title="Genome"></select>
      </div>
      <div id="rules-overlay" hidden></div>
    </div>

    <aside id="ui-panel">
      <div class="control-group">
        <label for="gene-select"><b>Genome (YAML)</b></label>
        <div class="row">
          <select id="gene-select" style="flex:1"></select>
          <button id="download-yaml-button" class="toggle-btn" title="Export current genome">‚§ì Export</button>
        </div>
        <div class="row" style="margin-top:6px">
          <label for="gene-upload">Upload:</label>
          <input id="gene-upload" type="file"
                 accept=".yaml,.yml,.json,application/x-yaml,text/yaml,application/json"/>
        </div>
      </div>

      <div class="control-group">
      <h4>Tools</h4>
      <div class="toggle-group">
        <button id="tool-move-button" class="toggle-btn active" title="Move / pan / drag nodes">üñêÔ∏è Move</button>
        <button id="tool-scissors-button" class="toggle-btn" title="Cut edges while dragging">‚úÇÔ∏è Scissors</button>
        <button id="slowdown-button" class="toggle-btn" title="Toggle slow mode">üê¢ Slow down</button>
        <button id="sound-toggle-button" class="toggle-btn active" title="Toggle mechanical ticking sound">
          üîà Sound
        </button>
      </div>
    </div>


      <div class="control-group">
        <h4>View</h4>
        <div class="toggle-group">
          <button id="view-2d-button" class="toggle-btn active" title="Standard 2D view">
            2D
          </button>
          <button id="view-3d-button" class="toggle-btn" title="Experimental 3D view">
            3D (beta)
          </button>
        </div>
      </div>

      <div class="control-group">
        <h4>Graph Constraints</h4>
        <label><input type="checkbox" id="maintain-single-component" checked> Maintain a single component</label>
        <div style="margin-top:6px"></div>
        <label><input type="checkbox" id="auto-center-checkbox" checked> Smooth auto‚Äëcenter</label>
        <label><input type="checkbox" id="auto-scale-checkbox" checked> Smooth auto‚Äëscale</label>
      </div>

      <div id="rules-section" class="control-group">
        <h4>Rules (Genes)</h4>
        <div class="board" id="rule-board"></div>
        <div style="margin-top:6px">
          <button id="toggle-rules-btn" class="toggle-btn" style="display:none">Show more</button>
        </div>
        <div id="gene-inspector" class="control-group" style="margin-top:6px">
          <h4>Gene Inspector</h4>
          <div id="gene-inspector-body" style="font-size:.9rem; color:#374151">
            Hover a rule tile to see its description. Click a tile to enable/disable that rule.
          </div>
        </div>
      </div>
      <div id="node-inspector" class="control-group">
        <h4>Node Inspector</h4>
        <div id="node-inspector-body" style="font-size:.9rem; color:#374151">
          Select the üñêÔ∏è Move tool, then hover a node to see details.
        </div>
      </div>

      <div class="control-group">
        <div class="row">
          <button id="pause-resume-button">Start</button>
          <button id="next-step-button">Next step</button>
          <button id="reset-button">Reset</button>
        </div>
      </div>

      <details class="block" id="settings-block">
        <summary>‚öôÔ∏è Machine settings</summary>
        <div class="row" style="margin-top:6px">
          <label for="max-steps-input">Max iterations:</label>
          <input id="max-steps-input" type="number" value="120" min="-1" step="1" style="width:120px">
          <small>(-1 = unlimited)</small>
        </div>       
        <div class="row" style="margin-top:8px">
          <label><input type="checkbox" id="orphan-cleanup-checkbox"> Auto-dissolve detached subgraphs</label>
        </div>
        <div class="row" style="margin-top:6px">
        <label>
          <input type="checkbox" id="reseed-isolated-a-checkbox" checked>
          Reseed isolated A nodes as new roots
        </label>
      </div>
      </details>

      <details class="block" id="advanced-block">
        <summary>üß™ Advanced (debug)</summary>
        <div class="row" style="margin:6px 0">
          <label for="display-options">Display:</label>
          <select id="display-options">
            <option value="edges">Edges</option>
            <option value="nodes">Nodes</option>
            <option value="both">Nodes & edges</option>
          </select>
        </div>
        <div class="row" style="margin:6px 0">
          <label for="simulation-interval">Interval (ms):</label>
          <input type="range" id="simulation-interval" min="50" max="2000" value="100">
          <span id="simulation-interval-value">100</span> ms
        </div>

        <div class="control-buttons">
          <button id="connect-button">Connect</button>
          <label for="source-node">Source:</label>
          <select id="source-node"></select>
          <label for="target-node">Target:</label>
          <select id="target-node"></select>
        </div>
        <div class="control-buttons">
          <button id="add-node-button">Add Node</button>
          <label for="node-state">State:</label>
          <select id="node-state"></select>
        </div>
        <div class="control-buttons">
          <button id="remove-node-button">Remove Node</button>
          <label for="remove-node-id">Node ID:</label>
          <select id="remove-node-id"></select>
        </div>
        <div class="control-buttons">
          <button id="change-node-state-button">Change Node State</button>
          <label for="change-node-id">Node:</label>
          <select id="change-node-id"></select>
          <label for="change-node-state">State:</label>
          <select id="change-node-state"></select>
        </div>
        <div class="control-buttons">
          <button id="disconnect-button">Disconnect</button>
          <label for="disconnect-source-node">Source:</label>
          <select id="disconnect-source-node"></select>
          <label for="disconnect-target-node">Target:</label>
          <select id="disconnect-target-node"></select>
        </div>
        <div class="control-buttons">
          <button id="connect-nearest-button">Connect Nearest</button>
          <label for="connect-nearest-node">Node:</label>
          <select id="connect-nearest-node"></select>
          <label for="connect-nearest-state">State:</label>
          <select id="connect-nearest-state"></select>
        </div>
      </details>

      <details class="block" id="palette-block">  <!-- no 'open' attribute = collapsed default -->
        <summary role="button" tabindex="0">üé® Color palette (debug)</summary>
        <div id="palette-grid" class="palette-grid"
            title="Hover a swatch to see its index and color name"></div>
      </details>
    </aside>
  </div>

  <footer>
    <div class="left">
      <span id="status-info">Nodes: 0 | Edges: 0 | Iterations: 0</span>
    </div>
    <div class="right">
      <span class="pill">Zoom: wheel ‚Ä¢ Pan: drag (Move)</span>
    </div>
  </footer>

  <script src="dist/bundle.js" type="module"></script>
</body>
</html>
